name: Post outage report to X
on:
  repository_dispatch:
    types: [outage_reported]

concurrency:
  group: outage-tweets
  cancel-in-progress: false

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install tweepy

      - name: Build message (privacy + timezone)
        id: build
        env:
          CITY:          ${{ github.event.client_payload.city }}
          DEPT:          ${{ github.event.client_payload.dept }}
          ADDRESS:       ${{ github.event.client_payload.address }}
          POSTAL_CODE:   ${{ github.event.client_payload.postal_code }}
          TS_ISO:        ${{ github.event.client_payload.timestamp_iso }}
          EXTRA:         ${{ github.event.client_payload.extra }}
          TOOL_URL:      ${{ github.event.client_payload.tool_url }}
        run: |
          python - << 'PY'
          import os, sys, hashlib
          from datetime import datetime
          try:
            from zoneinfo import ZoneInfo
          except Exception:
            ZoneInfo = None

          city  = (os.environ.get("CITY") or "").strip()
          dept  = (os.environ.get("DEPT") or "").strip()
          addr  = (os.environ.get("ADDRESS") or "").strip()
          pc    = (os.environ.get("POSTAL_CODE") or "").strip()
          extra = (os.environ.get("EXTRA") or "").strip()
          tsiso = (os.environ.get("TS_ISO") or "").strip()
          tool  = (os.environ.get("TOOL_URL") or "").strip()

          if not city or not tsiso:
            print("::error::Missing city or timestamp_iso"); sys.exit(1)

          # Obfuscation: masque n¬∞ de rue pour la vie priv√©e
          def obfuscate(a:str)->str:
            if not a: return ""
            a = " ".join(a.replace("#","").split())
            parts = a.split(",")
            head = parts[0].split()
            if head and head[0].isdigit():
              head = ["üî¢"] + head[1:]
            head = " ".join(head)
            tail = ", ".join([p.strip() for p in parts[1:] if p.strip()])
            return head + (", " + tail if tail else "")

          addr_pub = obfuscate(addr)

          # Heure locale Europe/Paris
          pretty_time = tsiso
          try:
            dt = datetime.fromisoformat(tsiso.replace("Z","+00:00"))
            if ZoneInfo:
              pretty_time = dt.astimezone(ZoneInfo("Europe/Paris")).strftime("%d/%m %H:%M")
          except Exception:
            pass

          # Compose le tweet
          line1 = f"‚ö°Ô∏è Coupure signal√©e √† {city}"
          if dept: line1 += f" ({dept})"
          if pc:   line1 += f" {pc}"
          line1 += f" ‚Äî {pretty_time}"

          lines = [line1]
          if addr_pub: lines.append(f"üìç {addr_pub}")
          if extra:    lines.append(f"‚ÑπÔ∏è {extra}")
          if tool:     lines.append(tool)

          msg = "\n".join([l for l in lines if l]).strip()
          msg = msg[:280]  # s√ªret√© 280 chars

          # D√©dup (ville+adresse+timestamp)
          key = hashlib.sha256((city+"|"+addr+"|"+tsiso).encode()).hexdigest()[:16]

          print(f"message<<EOF\n{msg}\nEOF")
          print(f"dedup_key={key}")
          PY

      - name: Skip if duplicate
        id: dedup
        uses: actions/cache@v4
        with:
          path: .dedup-marker
          key: outage-tweet-${{ steps.build.outputs.dedup_key }}

      - name: Mark as seen
        if: steps.dedup.outputs.cache-hit != 'true'
        run: echo "seen" > .dedup-marker

      - name: Send tweet
        if: steps.dedup.outputs.cache-hit != 'true'
        env:
          API_KEY:        ${{ secrets.X_API_KEY }}
          API_SECRET:     ${{ secrets.X_API_KEY_SECRET }}
          ACCESS_TOKEN:   ${{ secrets.X_ACCESS_TOKEN }}
          ACCESS_SECRET:  ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          TWEET_MESSAGE:  ${{ steps.build.outputs.message }}
        run: |
          python - << 'PY'
          import os, tweepy
          auth = tweepy.OAuth1UserHandler(
            os.environ["API_KEY"],
            os.environ["API_SECRET"],
            os.environ["ACCESS_TOKEN"],
            os.environ["ACCESS_SECRET"]
          )
          tweepy.API(auth).update_status(status=os.environ["TWEET_MESSAGE"])
          print("Tweet sent.")
          PY
