name: Post outage report to X

on:
  repository_dispatch:
    types: [outage_reported]
  workflow_dispatch:
    inputs:
      city:
        description: "Ville"
        required: true
        type: string
        default: "Testville"
      dept:
        description: "Dept"
        required: false
        type: string
        default: "59"
      address:
        description: "Adresse"
        required: false
        type: string
        default: "12 Rue de la Paix"
      postal_code:
        description: "CP"
        required: false
        type: string
        default: "59000"
      extra:
        description: "Note"
        required: false
        type: string
        default: "Test dispatch"
      timestamp_iso:
        description: "Horodatage ISO (UTC)"
        required: false
        type: string
        default: "2025-11-06T10:00:00Z"
      tool_url:
        description: "Lien outil"
        required: false
        type: string
        default: "https://feppn.github.io/Coupures_enedis/"

concurrency:
  group: outage-tweets
  cancel-in-progress: false

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install tweepy

      - name: Build message (privacy + timezone)
        id: build
        env:
          CITY:        ${{ github.event.client_payload.city        || github.event.inputs.city }}
          DEPT:        ${{ github.event.client_payload.dept        || github.event.inputs.dept }}
          ADDRESS:     ${{ github.event.client_payload.address     || github.event.inputs.address }}
          POSTAL_CODE: ${{ github.event.client_payload.postal_code || github.event.inputs.postal_code }}
          TS_ISO:      ${{ github.event.client_payload.timestamp_iso || github.event.inputs.timestamp_iso }}
          EXTRA:       ${{ github.event.client_payload.extra       || github.event.inputs.extra }}
          TOOL_URL:    ${{ github.event.client_payload.tool_url    || github.event.inputs.tool_url }}
        shell: bash
        run: |
          python - <<'PY'
          import os, sys, hashlib
          from datetime import datetime
          try:
              from zoneinfo import ZoneInfo
          except Exception:
              ZoneInfo = None

          city  = (os.environ.get("CITY") or "").strip()
          dept  = (os.environ.get("DEPT") or "").strip()
          addr  = (os.environ.get("ADDRESS") or "").strip()
          pc    = (os.environ.get("POSTAL_CODE") or "").strip()
          extra = (os.environ.get("EXTRA") or "").strip()
          tsiso = (os.environ.get("TS_ISO") or "").strip()
          tool  = (os.environ.get("TOOL_URL") or "").strip()

          if not city or not tsiso:
              print("::error::Missing city or timestamp_iso"); sys.exit(1)

          # Obfuscation de l'adresse pour la vie priv√©e (on masque le n¬∞ de rue)
          def obfuscate(a: str) -> str:
              if not a:
                  return ""
              a = " ".join(a.replace("#", "").split())
              parts = a.split(",")
              head = parts[0].split()
              if head and head[0].isdigit():
                  head = ["üî¢"] + head[1:]
              head = " ".join(head)
              tail = ", ".join([p.strip() for p in parts[1:] if p.strip()])
              return head + (", " + tail if tail else "")

          addr_pub = obfuscate(addr)

          # Heure locale Europe/Paris (on ne garde que l'heure)
          pretty_time = tsiso
          try:
              dt = datetime.fromisoformat(tsiso.replace("Z", "+00:00"))
              if ZoneInfo:
                  pretty_time = dt.astimezone(ZoneInfo("Europe/Paris")).strftime("%H:%M")
          except Exception:
              pass

          # On choisit ce qu'on affiche comme "rue"
          rue = addr_pub or city

          # D√©partement (sinon code postal √† d√©faut)
          dept_or_cp = dept or pc

          # 1√®re ligne : mod√®le demand√©
          line1 = f"‚ö° Coupure d‚Äô√©lectricit√© signal√©e √† {rue}, {city}"
          if dept_or_cp:
              line1 += f" ({dept_or_cp})"
          line1 += f" √† {pretty_time}"

          # Lignes suivantes fixes
          line2 = "Nos √©quipes suivent la situation de pr√®s."
          line3 = "üì° Restez inform√©s avec #CoupureElec by @panne_papernest"

          lines = [line1, "", line2, "", line3, "", line4]

          msg = "\n".join(lines).strip()[:280]

          # D√©dup (ville+adresse+timestamp) inchang√©
          key = hashlib.sha256((city + "|" + addr + "|" + tsiso).encode()).hexdigest()[:16]

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              print("message<<EOF", file=f)
              print(msg, file=f)
              print("EOF", file=f)
              print(f"dedup_key={key}", file=f)
          PY

      - name: Skip if duplicate
        id: dedup
        uses: actions/cache@v4
        with:
          path: .dedup-marker
          key: outage-tweet-${{ steps.build.outputs.dedup_key }}

      - name: Mark as seen
        if: steps.dedup.outputs.cache-hit != 'true'
        run: echo "seen" > .dedup-marker

      - name: Send tweet
        if: steps.dedup.outputs.cache-hit != 'true'
        env:
          API_KEY:        ${{ secrets.X_API_KEY }}
          API_SECRET:     ${{ secrets.X_API_KEY_SECRET }}
          ACCESS_TOKEN:   ${{ secrets.X_ACCESS_TOKEN }}
          ACCESS_SECRET:  ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          TWEET_MESSAGE:  ${{ steps.build.outputs.message }}
        run: |
          python - <<'PY'
          import os, tweepy
          client = tweepy.Client(
              consumer_key=os.environ["API_KEY"],
              consumer_secret=os.environ["API_SECRET"],
              access_token=os.environ["ACCESS_TOKEN"],
              access_token_secret=os.environ["ACCESS_SECRET"],
          )
          me = client.get_me()
          print("Posting as:", me.data.username if me and me.data else "(unknown)")
          resp = client.create_tweet(text=os.environ["TWEET_MESSAGE"])
          print("Tweet sent. ID:", resp.data.get("id"))
          PY
